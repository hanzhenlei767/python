<html>
<head>
  <title>十、Python多线程及多进程</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="691"/>
<h1>十、Python多线程及多进程</h1>

<div>
<span><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#Python</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">多线程</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">与</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">多进程 </span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#单线程程序</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">from threading import Thread</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">def my_counter():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    i = 0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in range(100000000):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        i = i + 1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    return True</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def main():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    start_time = time.time()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for tid in range(2):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t = Thread(target = my_counter)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t.start()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #<span style="font-family: 楷体; font-size: 16pt; color: rgb(255, 0, 0);">join的作用是保证当前线程执行完成后，再执行其它线程。join可以有timeout参数，表示阻塞其它线程timeout秒后，不再阻塞</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print(&quot;I am tid&quot;)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    end_time = time.time()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(&quot;Total time:{}&quot;.format(end_time - start_time))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if __name__ == '__main__':</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    main()</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#多线程程序</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">from threading import Thread</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def my_counter():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    i = 0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in range(100000000):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        i = i + 1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    return True</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def main():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    thread_array = {}</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    start_time = time.time()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for tid in range(2):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t = Thread(target = my_counter)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t.start()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        thread_array[tid] = t</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in range(2):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        thread_array[i].join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print(i)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    end_time = time.time()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(&quot;Total time:{}&quot;.format(end_time - start_time))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if __name__ == '__main__':</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    main()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：#两个线程同时完事，同时打印出了0，1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">I am tid</span></div><div><span style="font-size: 16pt; font-family: 楷体;">I am tid</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Total time:8.891999959945679</span></div><div><span style="font-size: 16pt; font-family: 楷体;">0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Total time:8.86080026626587</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#Python多线程Join的用法</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">import threading, time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def Myjoin():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print ('hello world!')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    time.sleep(1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">for i in range(5):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    t=threading.Thread(target=Myjoin)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    t.start()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">   </span> <span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#</span><span style="letter-spacing: normal; orphans: 2; text-indent: 0px; text-transform: none; white-space: normal; widows: 2; word-spacing: 0px; -webkit-text-stroke-width: 0px; font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">join的作用是保证当前线程执行完成后，再执行其它线程。join可以有timeout参数，表示阻塞其它线程timeout秒后，不再阻塞</span></div><div><span style="font-size: 16pt; font-family: 楷体;">  </span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体; font-weight: bold;">  t.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print('hello main')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#每s打印一次</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">[Finished in 5.1s]</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">import threading, time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def Myjoin():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print ('hello world!')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    time.sleep(1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">for i in range(5):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    t=threading.Thread(target=Myjoin)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    t.start()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">   </span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;"> #t.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print('hello main')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#打印完成之后，延迟1s</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello world!</span></div><div><span style="font-size: 16pt; font-family: 楷体;">hello main</span></div><div><span style="font-size: 16pt; font-family: 楷体;">[Finished in 1.1s]</span></div><div><br/></div><div><br/></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#multiprocessing</span></div><div><span style="font-size: 16pt; font-family: 楷体;">#multiprocessing是跨平台版本的多进程模块，它提供了一个Process类来代表一个进程对象</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from multiprocessing import Process</span></div><div><span style="font-size: 16pt; font-family: 楷体;">#多进程模块multiprocessing，提供了一个Process类类代表一个进程对象</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def f(n):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    time.sleep(1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print (n*n)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if __name__ == '__main__':</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in range(10):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        p = Process(target = f,args = [i,])</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        p.start()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：#哪个进程先执行完成不确定，每个进程执行完成后延迟1s,多进程体现出了省时、并发</span></div><div><span style="font-size: 16pt; font-family: 楷体;">16</span></div><div><span style="font-size: 16pt; font-family: 楷体;">1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">25</span></div><div><span style="font-size: 16pt; font-family: 楷体;">9</span></div><div><span style="font-size: 16pt; font-family: 楷体;">0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">4</span></div><div><span style="font-size: 16pt; font-family: 楷体;">36</span></div><div><span style="font-size: 16pt; font-family: 楷体;">81</span></div><div><span style="font-size: 16pt; font-family: 楷体;">64</span></div><div><span style="font-size: 16pt; font-family: 楷体;">49</span></div><div><span style="font-size: 16pt; font-family: 楷体;">[Finished in 1.7s]</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#进程间通信Queue</span></div><div><span style="font-size: 16pt; font-family: 楷体;">#Queue是多进程安全的队列，可以使用Queue实现多进程之间的数据传递</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from multiprocessing import Process#多进程模块multiprocessing的进程类Process</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from multiprocessing import Queue#多进程模块multiprocessing的队列类Queue</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def write(q):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print('write start')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in ['A','B','C','D']:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print('Put %s to queue' % i)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        q.put(i)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        time.sleep(1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def read(q):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print('read start')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    while True:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        v = q.get(True)#读队列成功</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print('get %s from queue' % v)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if __name__ == '__main__':</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    q = Queue()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pw = Process(target = write,args = (q,))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(pw)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pr = Process(target = read,args = (q,))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(pr)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(pw.start())</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(pr.start())</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pw.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pr.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pw.terminate()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pr.terminate()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：</span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#pr进程未启动？？？？？</span></div><div><span style="font-size: 16pt; font-family: 楷体;">&lt;Process(Process-1, initial)&gt;</span></div><div><span style="font-size: 16pt; font-family: 楷体;">&lt;Process(Process-2, initial)&gt;</span></div><div><span style="font-size: 16pt; font-family: 楷体;">None</span></div><div><span style="font-size: 16pt; font-family: 楷体;">None</span></div><div><span style="font-size: 16pt; font-family: 楷体;">write start</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Put A to queue</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Put B to queue</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Put C to queue</span></div><div><span style="font-size: 16pt; font-family: 楷体;">Put D to queue</span></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#进程池Pool</span></div><div><span style="font-size: 16pt; font-family: 楷体;">#用于批量创建进程，可以灵活控制子进程数量</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from multiprocessing import Pool</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def f(x):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(x)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    time.sleep(1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    return x * x</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if __name__ == '__main__':</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    #定义启动进程的数量</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pool = Pool(processes = 5)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    res_list = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for i in range(10):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #以异步并行的方式启动进程，如果要同步等待的方式可以在启动</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #进程之后调用res.get()方法，也可以使用Pool.apply</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        res = pool.apply_async(f,[i,])</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print(i)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        res_list.append(res)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pool.close()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    pool.join()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for r in res_list:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print (&quot;result&quot;,(r.get(timeout = 5)))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">运行结果：</span></div><div><span style="font-size: 16pt; font-family: 楷体;">0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">2</span></div><div><span style="font-size: 16pt; font-family: 楷体;">3</span></div><div><span style="font-size: 16pt; font-family: 楷体;">4</span></div><div><span style="font-size: 16pt; font-family: 楷体;">5</span></div><div><span style="font-size: 16pt; font-family: 楷体;">6</span></div><div><span style="font-size: 16pt; font-family: 楷体;">7</span></div><div><span style="font-size: 16pt; font-family: 楷体;">8</span></div><div><span style="font-size: 16pt; font-family: 楷体;">9</span></div><div><span style="font-size: 16pt; font-family: 楷体;">1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">6</span></div><div><span style="font-size: 16pt; font-family: 楷体;">0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">5</span></div><div><span style="font-size: 16pt; font-family: 楷体;">2</span></div><div><span style="font-size: 16pt; font-family: 楷体;">7</span></div><div><span style="font-size: 16pt; font-family: 楷体;">3</span></div><div><span style="font-size: 16pt; font-family: 楷体;">8</span></div><div><span style="font-size: 16pt; font-family: 楷体;">4</span></div><div><span style="font-size: 16pt; font-family: 楷体;">9</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 0</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 1</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 4</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 9</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 16</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 25</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 36</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 49</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 64</span></div><div><span style="font-size: 16pt; font-family: 楷体;">result 81</span></div><div><span style="font-size: 16pt; font-family: 楷体;">[Finished in 2.5s]</span></div><div><br/></div><div><br/></div><div><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">#fork操作</span></div><div><span style="font-size: 16pt; font-family: 楷体; font-weight: bold;">调用一次，返回两次。</span><span style="font-size: 16pt; font-family: 楷体;">因为操作系统自动把当前进程（称为父</span><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">进程）复制了一份（称为子进程），</span></div><div><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">然后分别在父进程和子进</span><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">程内返回。子进程永远返回0，而父进程返回子进程的ID。</span></div><div><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">子</span><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">进程只需要调用getppid()就可以拿到父进程的ID。</span><span style="font-size: 16pt; font-family: 楷体; line-height: 1.45;">getpid()拿到自己的ID。</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">import os</span></div><div><span style="font-size: 16pt; font-family: 楷体;">print('Process (%s) start...' % os.getpid())</span></div><div><span style="font-size: 16pt; font-family: 楷体;">pid = os.fork()#AttributeError: module 'os' has no attribute 'fork'</span></div><div><span style="font-size: 16pt; font-family: 楷体;">if pid == 0:#子进程返回的</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(&quot;I am child process (%s) and my parent is %s.&quot; % (os.getpid(),os.getppid()))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">else:#父进程返回的</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(&quot;I (%s) just created a child process (%s).&quot; % (os.getpid(),pid))</span></div><div><br/></div><div><br style="font-family: 楷体; font-size: 16pt;"/></div></span>
</div></body></html> 