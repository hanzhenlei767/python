<html>
<head>
  <title>十四、数据提取清洗</title>
  <basefont face="微软雅黑" size="2" />
  <meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
  <meta name="exporter-version" content="Evernote Windows/307027 (zh-CN, DDL); Windows/6.1.0 (Win64);"/>
  <style>
    body, td {
      font-family: 微软雅黑;
      font-size: 10pt;
    }
  </style>
</head>
<body>
<a name="746"/>
<h1>十四、数据提取清洗</h1>

<div>
<span><div><a href="十四、数据提取清洗_files/2.py"><img src="十四、数据提取清洗_files/bd40203e19b21fbc3049664065fc3342.png" alt="2.py"></a></div><div><span style="font-size: 16pt; font-family: 楷体;">#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">面向对象版本的数据清洗</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">import os</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from threading import Thread</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from pandas import DataFrame,Series</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import xlrd, xlwt #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">引入读写工作表的库</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">import sys</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import numpy as np</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import matplotlib.pyplot as plt</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">abs_path = &quot;C:/Users/admin/Desktop/1&quot;</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">class ProcessData:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    all_key_data_dict = {}#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">所有的关键数据,类中使用类中的全局变量，需要加self</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">    </span></div><div><span style="font-size: 16pt; font-family: 楷体;">    #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">构造函数</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">    def __init__(self,abs_path):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.abs_path = abs_path</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">    #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取所有文件完整路径</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">    def get_all_file(self):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">传入存储的日志的绝对路径</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        all_file = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for file in os.listdir(self.abs_path):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">遍历路径path下的所有文件和文件夹</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            file_path = os.path.join(self.abs_path, file)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获得到文件的完整路径</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            if os.path.isfile(file_path): #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">判断是否为文件</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                all_file.append(file_path)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">将所有文件的路径存储在list里</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        return all_file</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">    #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">剔除非txt文件</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">    def filter_file(self,all_file_path):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">过滤文件，剔除非txt文件</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        all_txt_file = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for only_file_path in all_file_path:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            (file_abs_path,file_all_name) = os.path.split(only_file_path)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">拆分完整路径为文件路径和文件名</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            (file_name,extension) = os.path.splitext(file_all_name)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">拆分文件为文件名和文件后缀</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            if extension == &quot;.txt&quot;:#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">判断后缀是否是.txt文件</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                all_txt_file.append(only_file_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        return all_txt_file</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    </span></div><div><span style="font-size: 16pt; font-family: 楷体;">    def Myjob(self,num):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        key_data = []#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">存储最终关键数据</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        all_txt_file_list = self.filter_file(self.get_all_file())</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        with open(all_txt_file_list[num],'r') as f:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            while True:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                try:#异常处理</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    line = f.readline()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                if not line:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    break</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                else:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    str_list = line.strip().split(&quot;,&quot;)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">strip去除空格和换行符，split拆分字符串</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    if len(str_list) &gt; 2:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        head_list = str_list[0].split(':')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">拆分字符串</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        if len(head_list) == 4:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                            if head_list[3].strip() == &quot;spd&quot;:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                                del str_list[0]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                                <span style="font-size: 16pt; font-family: 楷体;">if str_list[1] != &quot;65535&quot;:#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">删除掉无效数据</span></span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                                    key_data.append(str_list)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        (file_abs_path,file_name) = os.path.split(all_txt_file_list[num])#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">拆分完整路径为文件路径和文件名</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.all_key_data_dict.update({file_name:key_data})#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">字典添加元素,类中全局变量需要加上self</span></span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">    def main(self):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        thread_array = {}#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">定义字典管理线程句柄</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        start_time = time.time()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获得开始时间</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        all_txt_file_list = self.filter_file(self.get_all_file())#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取所有的txt文件，类中方法需要前面加上self</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for var in range(len(all_txt_file_list)):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">有多少个文件启动多少个线程</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            t = Thread(target = self.Myjob,args = [var,])#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">创建线程</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            t.start()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">同时启动所有线程</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            thread_array[var] = t#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">存储线程句柄</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for var in range(len(all_txt_file_list)):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">循环等待所有线程完成</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            thread_array[var].join()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">join</span><span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">等待所有线程结束</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        end_time = time.time()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获得结束时间</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        print(&quot;Total time:{}&quot;.format(end_time - start_time))#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">打印全部线程执行完成耗时</span></span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">    def save_xls(self):#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">关键数据字典，绝对路径</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.all_key_data_dict = {}#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">清空字典（仅清空当前字典）</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.main()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        wb = xlwt.Workbook()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">创建工作簿</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for k,v in self.all_key_data_dict.items():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">用add_sheet添加工作表（sheet）</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            ws = wb.add_sheet(k, cell_overwrite_ok=True)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">创建sheet</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            data = np.array(list(v))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            <span style="font-size: 16pt; font-family: 楷体;">try:#防止空list报异常</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                data = data[:,5:8:1]#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">多维numpy数组切片</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            <span style="font-size: 16pt; font-family: 楷体;">except:</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            <span style="font-size: 16pt; font-family: 楷体;">else:</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                shape = data.shape#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取numpy数组的行，列</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                            ws.write(r, c,int(data[r,c]))#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">r行，c列;将字符串转换成int类型</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                            pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        temp_path = os.path.join(self.abs_path, 'data_xls')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            os.mkdir(temp_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        xls_path = os.path.join(temp_path, &quot;data.xls&quot;)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        wb.save(xls_path)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">保存指定目录中</span></span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">    def save_pic(self):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.all_key_data_dict.clear()#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">清空字典（引用型清空字典）</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">        self.main()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        int_sbi = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        int_spd = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        int_ebi = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for k,v in self.all_key_data_dict.items():#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">字典遍历</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            del int_sbi[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            del int_spd[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            del int_ebi[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            data = np.array(list(v))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            <span style="font-size: 16pt; font-family: 楷体;">try:</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                sbi = data[:,5:6:1]#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">多维numpy数组切片</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                spd = data[:,6:7:1]#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">多维numpy数组切片</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ebi = data[:,7:8:1]#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">多维numpy数组切片</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">            <span style="font-size: 16pt; font-family: 楷体;">except:</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            else:</span><span style="font-size: 16pt; font-family: 楷体;"> </span></div><div><span style="font-size: 16pt; font-family: 楷体;">                shape = sbi.shape#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取numpy数组的行，列</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        int_sbi.append(int(sbi[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                shape = spd.shape#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取numpy数组的行，列</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        int_spd.append(int(spd[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                shape = ebi.shape#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">获取numpy数组的行，列</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        int_ebi.append(int(ebi[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">生成图片</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                fig = plt.figure();</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax = fig.add_subplot(1, 1, 1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.plot(int_sbi, 'k', label='sbi')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.plot(int_spd, 'b', label='spd')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.plot(int_ebi, 'r', label='ebi')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                #ticks = ax.set_yticks([0, 100, 200, 300, 400])#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">改变y轴的刻度</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                #<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">将对应的刻度用标签修改</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                #labels = ax.set_yticklabels(['one', 'two', 'three', 'four', 'five'],rotation=30, fontsize='small')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">改变x轴的标签</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.set_title('Train Speed Lines')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">设置标题</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.set_xlabel('200ms*x')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">设置x轴标签</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.set_ylabel('cm/s')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">设置y轴标签</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                ax.legend(loc='best')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">legend添加图例。loc在最佳的位置上显示标签</span></span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">                temp_path = os.path.join(self.abs_path, 'data_pic')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    os.mkdir(temp_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                (pic_name,extension) = os.path.splitext(k)#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">提取文件名</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                pic_path = os.path.join(temp_path, pic_name)#+'.pdf')#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">默认png图片格式，可随意设置格式</span></span></div><div><span style="font-size: 16pt; font-family: 楷体;">                fig.savefig(pic_path)</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">process = ProcessData(abs_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">process.save_xls()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">process.save_pic()</span></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">#<span style="font-size: 16pt; font-family: 楷体; color: rgb(255, 0, 0);">面向过程</span></span><span style="font-size: 16pt; color: rgb(255, 0, 0); font-family: 楷体;">版本的数据清洗</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import os</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import time</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from threading import Thread</span></div><div><span style="font-size: 16pt; font-family: 楷体;">from pandas import DataFrame,Series</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import xlrd, xlwt #引入读写工作表的库</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import sys</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import numpy as np</span></div><div><span style="font-size: 16pt; font-family: 楷体;">import matplotlib.pyplot as plt</span></div><div><span style="font-size: 16pt; font-family: 楷体;">abs_path = &quot;C:/Users/admin/Desktop/1&quot;</span></div><div><span style="font-size: 16pt; font-family: 楷体;">all_key_data_dict = {}#所有的关键数据</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def get_all_file(abs_path):#传入存储的日志的绝对路径</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    all_file = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for file in os.listdir(abs_path):#遍历路径path下的所有文件和文件夹</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        file_path = os.path.join(abs_path, file)#获得到文件的完整路径</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        if os.path.isfile(file_path): #判断是否为文件</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            all_file.append(file_path)#将所有文件的路径存储在list里</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    return all_file</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def filter_file(all_file_path):#过滤文件，剔除非txt文件</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    all_txt_file = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for only_file_path in all_file_path:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        (file_abs_path,file_all_name) = os.path.split(only_file_path)#拆分完整路径为文件路径和文件名</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        (file_name,extension) = os.path.splitext(file_all_name)#拆分文件为文件名和文件后缀</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        if extension == &quot;.txt&quot;:#判断后缀是否是.txt文件</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            all_txt_file.append(only_file_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    return all_txt_file</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def Myjob(num):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    key_data = []#存储最终关键数据</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    with open(all_txt_file_list[num],'r') as f:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        while True:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            try:#异常处理</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                line = f.readline()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            if not line:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                break</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            else:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                str_list = line.strip().split(&quot;,&quot;)#strip去除空格和换行符，split拆分字符串</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                if len(str_list) &gt; 2:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    head_list = str_list[0].split(':')#拆分字符串</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    if len(head_list) == 4:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                        if head_list[3].strip() == &quot;spd&quot;:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                            del str_list[0]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                            key_data.append(str_list)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    (file_abs_path,file_name) = os.path.split(all_txt_file_list[num])#拆分完整路径为文件路径和文件名</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    all_key_data_dict.update({file_name:key_data})#字典添加元素</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def save_xls(all_key_data_dict,abs_path):#关键数据字典，绝对路径</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    wb = xlwt.Workbook()#创建工作簿</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for k,v in all_key_data_dict.items():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #用add_sheet添加工作表（sheet）</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ws = wb.add_sheet(k, cell_overwrite_ok=True)#创建sheet</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        data = np.array(list(v))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        data = data[:,5:8:1]#多维numpy数组切片</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        shape = data.shape#获取numpy数组的行，列</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    ws.write(r, c,int(data[r,c]))#r行，c列;将字符串转换成int类型</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                    pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    temp_path = os.path.join(abs_path, 'data_xls')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        os.mkdir(temp_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    xls_path = os.path.join(temp_path, &quot;data.xls&quot;)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    wb.save(xls_path)#保存工作表到</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def save_pic(all_key_data_dict,abs_path):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    int_sbi = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    int_spd = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    int_ebi = []</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for k,v in all_key_data_dict.items():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        del int_sbi[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        del int_spd[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        del int_ebi[:]</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        data = np.array(list(v))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        sbi = data[:,5:6:1]#多维numpy数组切片</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        spd = data[:,6:7:1]#多维numpy数组切片</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ebi = data[:,7:8:1]#多维numpy数组切片</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        shape = sbi.shape#获取numpy数组的行，列</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                int_sbi.append(int(sbi[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        shape = spd.shape#获取numpy数组的行，列</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                int_spd.append(int(spd[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        shape = ebi.shape#获取numpy数组的行，列</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        for r in range(shape[0]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            for c in range(shape[1]):</span></div><div><span style="font-size: 16pt; font-family: 楷体;">                int_ebi.append(int(ebi[r,c]))</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        fig = plt.figure();</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax = fig.add_subplot(1, 1, 1)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.plot(int_sbi, 'k', label='sbi')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.plot(int_spd, 'b', label='spd')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.plot(int_ebi, 'r', label='ebi')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #ticks = ax.set_yticks([0, 100, 200, 300, 400])#改变y轴的刻度</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #将对应的刻度用标签修改</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        #labels = ax.set_yticklabels(['one', 'two', 'three', 'four', 'five'],rotation=30, fontsize='small')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.set_title('Train Speed Lines')#设置标题</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.set_xlabel('200ms*x')#设置x轴标签</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.set_ylabel('cm/s')#设置y轴标签</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        ax.legend(loc='best')#legend添加图例。loc在最佳的位置上显示标签</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        temp_path = os.path.join(abs_path, 'data_pic')</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        try:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            os.mkdir(temp_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        except:</span></div><div><span style="font-size: 16pt; font-family: 楷体;">            pass</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        (pic_name,extension) = os.path.splitext(k)#提取文件名</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        pic_path = os.path.join(temp_path, pic_name)#+'.pdf')#默认png图片格式，可随意设置格式</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        fig.savefig(pic_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">def main():</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    thread_array = {}#定义字典管理线程句柄</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    start_time = time.time()#获得开始时间</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for var in range(len(all_txt_file_list)):#有多少个文件启动多少个线程</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t = Thread(target=Myjob,args = [var,])#创建线程</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        t.start()#同时启动所有线程</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        thread_array[var] = t#存储线程句柄</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    for var in range(len(all_txt_file_list)):#循环等待所有线程完成</span></div><div><span style="font-size: 16pt; font-family: 楷体;">        thread_array[var].join()#等待所有线程结束</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    end_time = time.time()#获得结束时间</span></div><div><span style="font-size: 16pt; font-family: 楷体;">    print(&quot;Total time:{}&quot;.format(end_time - start_time))#打印耗时</span></div><div><br/></div><div><br/></div><div><span style="font-size: 16pt; font-family: 楷体;">all_file_name_list = get_all_file(abs_path)#获取路径下所有文件的路径，存储在all_file_name_list里</span></div><div><span style="font-size: 16pt; font-family: 楷体;">all_txt_file_list = filter_file(all_file_name_list)#过滤非txt文件</span></div><div><span style="font-size: 16pt; font-family: 楷体;">main()</span></div><div><span style="font-size: 16pt; font-family: 楷体;">save_xls(all_key_data_dict,abs_path)</span></div><div><span style="font-size: 16pt; font-family: 楷体;">save_pic(all_key_data_dict,abs_path)</span></div><div><br style="font-family: 楷体; font-size: 16pt;"/></div><div><br/></div><div><br/></div><div><br style="font-family: 楷体; font-size: 16pt;"/></div><div><br style="font-family: 楷体; font-size: 16pt;"/></div></span>
</div></body></html> 